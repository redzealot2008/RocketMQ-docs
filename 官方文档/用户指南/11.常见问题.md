## 常见问题（FAQ）

以下问题是经常被问到的关于RocketMQ项目的问题。

#### 普遍
1. 为什么我们创建rocketmq项目而不是选择其他产品？  
    请参考[为什么选择RocketMQ][1]

2. 我必须安装其他软件，如zookeeper才能使用RocketMQ吗？  
    RocketMQ可以独立运行。

#### 用法
1. 新创建的消费者ID从哪里开始消费消息？
    1. 如果主题在三天内发送消息，则消费者从服务器中保存的第一条消息开始消费消息。
    2. 如果主题三天前发送消息，则消费者从服务器中的最新消息中开始消费消息，换句话说，从消息队列的尾部开始。
    3. 如果消费者重新启动，则它从上次消费位置开始消费消息。
    
2. 消费失败时如何重新消费消息？
    1. 集群消费模式消费者业务逻辑代码返回Action.ReconsumerLater，NULL或抛出异常，如果消息未能被消费，则将重试最多16次，之后消息将被丢弃。
    2. 广播消费模式广播消费仍然确保消息至少消费一次，但不提供重新发送选项。

3. 如果有消费失败，如何查询失败的消息？
    1. 按时间使用主题查询，您可以查询在一段时间内的消息。
    2. 使用主题和消息Id来准确地查询消息。
    3. 使用主题和消息Key准确地查询具有相同消息Key的同类消息。

4. 消息是否正确传送一次？  
    RocketMQ确保所有消息至少传输一次。在大多数情况下，消息不会重复。

5. 如何添加新的代理？
    1. 启动新的代理并将其注册到同一个名称服务器列表。
    2. 默认情况下，仅自动创建内部系统主题和消费者组。如果您希望在新节点上拥有您的业务主题和消费者组，请从现有的代理复制它们。提供管理工具和命令行来处理此问题。

#### 配置相关
以下答案都是默认值，可以通过配置进行修改。

1. 消息保存在服务器上多长时间？  
    存储的消息将被保存最多3天，并且超过3天没被消费的消息将被删除。

2. 消息体的大小限制是多少？  
    通常是256KB。

3. 如何设置消费者线程数？  
    当您启动Consumer时，设置ConsumeThreadNums属性，示例如下：
    ```
    consumer.setConsumeThreadMin(20);
    consumer.setConsumeThreadMax(20);
    ```

#### 错误
1. 如果您启动生产者或消费者失败，错误消息是生产者组或消费者重复？  
    原因：使用相同的Producer/Consumer Group在同一JVM中启动多个Producer/Consumer实例可能会导致客户端无法启动。

    解决方案：确保一个Producer/Consumer Group对应的JVM只启动一个Producer/Consumer实例。

2. 如果消费者无法在广播模式下启动加载json文件？  
    原因：Fastjson版本太低，无法让广播消费者加载本地的offsets.json，导致消费者启动失败。损坏的fastjson文件也可能导致同样的问题。  

    解决方案：Fastjson版本必须升级到rocketmq客户端依赖版本，以确保可以加载本地的offsets.json。默认情况下，offsets.json文件位于/home/{user}/.rocketmq_offsets中。或检查fastjson的完整性。

3. 代理崩溃的影响是甚么？
    1. 主代理崩溃  
    消息不能再发送到该代理集，但是如果您有其他代理集可用，则可以在该主题存在的情况下发送消息。消息仍然可以从从代理上消费。

    2. 一些从代理崩溃
    只要有另一个工作的从代理，就不会对发送消息产生影响。消费消息也不会有任何影响，除了将消费者组设置为最好从该从代理消费的时候。默认情况下，消费者组从主代理消费。

    3. 所有从代理都崩溃了  
    向主代理发送消息不会有任何影响，但是如果主代理是SYNC_MASTER，则生产者将获得SLAVE_NOT_AVAILABLE，指示该消息未发送到任何从代理。消费消息也不会有任何影响，除了将消费者组设置为最好从该从代理消费的时候。默认情况下，消费者组从主代理消费。

4. 生产者抱怨“No Topic Route Info”，如何诊断？  
    当您尝试将消息发送到对生产者路由信息不可用的主题时，会发生这种情况。

    1. 确保生产者可以连接到名称服务器，并且能够从中获取路由元信息。
    2. 确保名称服务器确实包含主题的路由元信息。您可以使用管理工具或Web控制台通过topicRoute从名称服务器查询路由元信息。
    3. 确保您的代理将心跳发送到您的生产者连接到的名称服务器列表中。
    4. 确保该主题的权限是6（rw-）或至少2（-w-）。
    
如果您找不到此主题，请通过管理工具命令updateTopic或Web控制台在代理上创建此主题。

[1]: https://rocketmq.apache.org/docs/motivation/

https://rocketmq.apache.org/docs/faq/